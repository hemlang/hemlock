// Sandbox functionality test
// This test exercises each restricted operation
// Run with: hemlock --sandbox tests/sandbox_test.hml

print("Testing sandbox restrictions...\n");

// Test 1: File write
print("Test 1: File write");
try {
    let f = open("/tmp/sandbox_test.txt", "w");
    f.write("test");
    f.close();
    print("  -> ALLOWED\n");
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

// Test 2: File read
print("Test 2: File read");
try {
    let f = open("/etc/hostname", "r");
    let content = f.read();
    f.close();
    print("  -> ALLOWED\n");
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

// Test 3: Process execution
print("Test 3: Process exec");
try {
    exec("echo hello");
    print("  -> ALLOWED\n");
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

// Test 4: Network socket
print("Test 4: Network socket");
try {
    // AF_INET=2, SOCK_STREAM=1
    let sock = socket_create(2, 1, 0);
    if (sock != null) {
        socket_close(sock);
        print("  -> ALLOWED\n");
    } else {
        print("  -> FAILED to create\n");
    }
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

// Test 5: Signal handler registration
print("Test 5: Signal handler");
try {
    signal(2, fn(sig) { print("Got signal"); });
    print("  -> ALLOWED\n");
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

// Test 6: Raise signal
print("Test 6: Raise signal");
try {
    raise(0);  // Signal 0 is a no-op but tests the restriction
    print("  -> ALLOWED\n");
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

// Test 7: Kill (send signal to process)
print("Test 7: Kill signal");
try {
    __kill(get_pid(), 0);  // Signal 0 just checks if process exists
    print("  -> ALLOWED\n");
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

// Test 8: Abort (we can't actually test this without terminating)
print("Test 8: Abort");
try {
    // We check if the function exists and is restricted
    // by catching the sandbox error
    __abort();
    print("  -> ALLOWED (would have aborted)\n");
} catch (e) {
    print("  -> BLOCKED: " + e + "\n");
}

print("\nDone.\n");
